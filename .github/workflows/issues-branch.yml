name: Update JSON issues

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created, edited]
  workflow_dispatch:

jobs:
  update-issues:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: read

    steps:
      # 1) Checkout workspace (we'll create/use an orphan data branch)
      - name: Checkout workspace
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: data-branch
          persist-credentials: true

      # 2) Ensure orphan data branch exists and is checked out
      - name: Ensure orphan data branch exists
        working-directory: data-branch
        shell: bash
        run: |
          set -euxo pipefail
          BRANCH="issues-json"
          if git ls-remote --exit-code --heads origin "$BRANCH" >/dev/null 2>&1; then
            git checkout "$BRANCH"
          else
            git checkout --orphan "$BRANCH"
            git rm -rf . || true
            echo "# Machine-generated issues JSON" > README.md
            git add -A
            git -c user.email="action@github.com" -c user.name="GitHub Action" commit -m "Initialize orphan $BRANCH branch"
            git push --set-upstream origin "$BRANCH"
          fi

      # 3) Create requirements.txt BEFORE setup-python (first run only)
      #    This lets setup-python's pip cache use it as the cache-dependency-path.
      - name: Ensure requirements.txt exists (pre-cache)
        working-directory: data-branch
        shell: bash
        run: |
          set -euxo pipefail
          if [ ! -f requirements.txt ]; then
            echo "fetch-github-issues" > requirements.txt
          fi

      # 4) Set up Python with pip cache keyed to requirements.txt
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          cache: 'pip'
          cache-dependency-path: data-branch/requirements.txt

      # 5) Install dependencies from the just-created/checked-in requirements.txt
      - name: Install dependencies
        working-directory: data-branch
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 6) Run fetch-github-issues from the data branch workspace
      - name: Run fetch-github-issues
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        working-directory: data-branch
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            fetch-github-issues simonw/todos --all
          else
            fetch-github-issues simonw/todos ${{ github.event.issue.number || github.event.comment.issue_number }}
          fi

      # 7) Commit and push changes (includes requirements.txt on first run)
      - name: Commit and push changes to data branch
        working-directory: data-branch
        shell: bash
        run: |
          set -euxo pipefail
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git add -A
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            commit_message="Update all JSON issues"
          else
            issue_number="${{ github.event.issue.number || github.event.comment.issue_number }}"
            commit_message="Update JSON for issue ${issue_number}"
          fi
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "$commit_message"
            git push
          fi
